function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&null!=a[Symbol.iterator]||null!=a["@@iterator"])return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}import jsIngrow from"js-ingrow-sdk";function getElementMainProps(a){var b=getDomPath(a).join(" > "),c=a.nodeName,d=a.id,e=a.className;return{path:b,nodeName:c,id:d,className:e}}var downProp={};function down(a){return function(b){var c=b.target,d=b.clientX,e=b.clientY;downProp=_objectSpread({isTouch:a,x:d,y:e},getElementMainProps(c))}}function up(a,b){return function(c){var d=c.target,e=c.clientX,f=c.clientY,g=e-downProp.x,h=f-downProp.y,i=g*g+h*h^!0?b?"tap":"click":"drag",j=_objectSpread(_objectSpread({isTouch:b,x:e,y:f},getElementMainProps(d)),{},{action:i});a(j)}}function captureMouseTouchEvents(a){var b=document.body.addEventListener;b("mousedown",down(a)),b("touchstart",down(a)),b("mouseup",up(a)),b("touchend",up(a,!0))}function capturePageEvents(a){document.addEventListener("DOMContentLoaded",function(){a({action:"load"})});var b=window.addEventListener;b("beforeunload",function(){a({action:"load"})}),b("unload",function(){a({action:"load"})})}function captureErrors(a){window.onerror=function(b,c,d){a({error:b,url:c,line:d})}}// Most of the following codes are copied from
// https://stackoverflow.com/questions/3219758/detect-changes-in-the-dom
// But I changed it because
// 1 - It didn't send the recordedChanges
// 2 - It didn't use MutationObserver when its available
// 3 - delay should not affect chunking recordedChanges and we should decide about the chunks out of this module
var naiveDelay=300,stack=[];// Manage event queue
function callback(a){for(var b=0;b<stack.length;b++)stack[b](a)}//Public interface
function subscribe(a,b){b&&(naiveDelay=b),stack.push(a)}// Naive approach for compatibility
function naive(){var a=document.getElementsByTagName("*"),b=a.length;setTimeout(function c(){// get current state of the document
var d=document.getElementsByTagName("*"),e=d.length;e!=b&&(a=[]);// go check every element in order
for(var f=0;f<e;f++)if(d[f]!==a[f]){callback(),a=d,b=e;break}// over, and over, and over again
setTimeout(c,naiveDelay)},naiveDelay)}// checks a particular event
function test(a){el.addEventListener(a,function b(){support[a]=!0,el.removeEventListener(a,b,!1)},!1)}var MutationObserver=window.MutationObserver||window.WebKitMutationObserver;if(MutationObserver){var mutationObserver=new MutationObserver(callback);// have the observer observe foo for changes in children
mutationObserver.observe(obj,{childList:!0,subtree:!0})}else{var support={},el=document.documentElement;window.addEventListener&&(test("DOMSubtreeModified"),test("DOMNodeInserted"),test("DOMNodeRemoved")),support.DOMNodeInserted?window.addEventListener("DOMContentLoaded",function(){support.DOMSubtreeModified?el.addEventListener("DOMSubtreeModified",callback,!1):(el.addEventListener("DOMNodeInserted",callback,!1),el.addEventListener("DOMNodeRemoved",callback,!1))},!1):document.onpropertychange?document.onpropertychange=callback:naive()}// do the dummy test
// var dummy = document.createElement("div");
// el.appendChild(dummy);
// el.removeChild(dummy);
var CheckDomChangesInterval=200;function captureDomChanges(a){subscribe(function(b){b.forEach(function(a){var b;return a.addedNodes.length&(b=addedNodes).push.apply(b,_toConsumableArray(a.addedNodes))}),b.forEach(function(a){var b;return a.removedNodes.length&(b=removedNodes).push.apply(b,_toConsumableArray(a.removedNodes))}),a(b)},CheckDomChangesInterval)}function passedSampleRate(a){return Math.random()<a}function autoGrabber(a,b){function c(a,b){a.length&&a[0](b,function(d){c(a.slice(1),d||b)})}var d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:[];if(!Array.isArray(d))throw"should pass an array to the middlewares";if(a.projectID&&a.apiKey){var e=a.projectID,f=a.apiKey,g=a.userID;new jsIngrow(e,f,user)}else if(a.sendEvent);else throw"ingrow be an instance of Ingrow class or contains ingrow sdk configs";b&&d.push(function(a,c){var d,e=null===(d=b[a.type])||void 0===d?void 0:d.rate;e=-1<e?e:1,passedSampleRate(e)&&c(a)}),d.push(function(b){a.send(b.stream,b.eventData,b.sendDeviceInfo)}),[{type:"mouse",stream:"events",sendDeviceInfo:!1,capture:captureMouseTouchEvents},{type:"page",stream:"events",sendDeviceInfo:!0,capture:capturePageEvents},{type:"domChange",stream:"events",sendDeviceInfo:!1,capture:captureDomChanges},{type:"error",stream:"events",sendDeviceInfo:!1,capture:captureErrors}].forEach(function(a){a.capture(function(b){a.eventData=b,c(d,b)})})}export{autoGrabber};
